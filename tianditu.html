<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>3dmap</title>
		<style>
			html,
			body,
			#viewDiv {
				padding: 0;
				margin: 0;
				height: 100%;
				width: 100%;
			}
			
			#PositionInfo {
				position: absolute;
				display: inline;
				bottom: 0px;
				color: white;
				height: 20px;
				width: 100%;
				box-shadow: none;
				background: rgb(0, 0, 0, 0.3);
				line-height: 20px;
			}
			
			.nomal-button {
				font-size: 16px;
				background-color: transparent;
				border: 1px solid #d3d3d3;
				color: #6e6e6e;
				height: 32px;
				width: 32px;
				text-align: center;
				box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
			}
			
			.action-button {
				font-size: 16px;
				background-color: transparent;
				border: 1px solid #d3d3d3;
				color: #6e6e6e;
				height: 32px;
				width: 32px;
				text-align: center;
				box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
			}
			
			.action-button:hover,
			.action-button:focus {
				background: #0079c1;
				color: #e4e4e4;
			}
			
			.active {
				background: #0079c1;
				color: #e4e4e4;
			}
		</style>

		<link rel="stylesheet" href="https://js.arcgis.com/4.13/esri/css/main.css">
		<script src="https://js.arcgis.com/4.13/"></script>
		<script type="text/javascript" src="js/coordTransfer.js"></script>
		<!--读取配置文件方法-->
		<script>
			window.onload = function() {
				var url = "json/setting.json" /*json文件url，本地的就写本地的位置，如果是服务器的就写服务器的路径*/
				var request = new XMLHttpRequest();
				request.open("get", url); /*设置请求方法与路径*/
				request.send(null); /*不发送数据到服务器*/
				request.onload = function() { /*XHR对象获取到返回信息后执行*/
					if(request.status == 200) { /*返回状态为200，即为数据获取成功*/
						var json = JSON.parse(request.responseText);
						for(var i = 0; i < json.length; i++) {
							console.log(json[i].name);
						}
						console.log(json.map_view);
					}
				}
			}
		</script>

		<script>
			var map, view;
			require(["esri/Map", "esri/views/MapView", "esri/views/SceneView", "esri/layers/BaseTileLayer", "esri/layers/support/TileInfo", "esri/layers/WebTileLayer", "esri/symbols/LabelSymbol3D", "esri/Color", "esri/widgets/DirectLineMeasurement3D/DirectLineMeasurement3DViewModel", "esri/widgets/AreaMeasurement3D/AreaMeasurement3DViewModel",
					"esri/config", "esri/Basemap", "esri/request", "esri/widgets/BasemapGallery", "esri/widgets/Expand", "esri/widgets/ScaleBar",
					"esri/layers/TileLayer", "esri/layers/MapImageLayer", "esri/layers/FeatureLayer", "esri/widgets/LayerList", "esri/core/urlUtils",
					"esri/tasks/QueryTask", "esri/tasks/support/Query", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/geometry/Point", "esri/symbols/TextSymbol", "esri/layers/ElevationLayer",
					"esri/layers/support/LabelClass", "esri/WebMap", "esri/views/2d/draw/Draw", "esri/geometry/Polygon", "esri/geometry/Polyline",
					"esri/geometry/geometryEngine", "esri/widgets/Legend", "esri/symbols/PictureMarkerSymbol", "esri/symbols/Font", "esri/tasks/IdentifyTask", "esri/tasks/support/IdentifyParameters", "dojo/_base/array",
					"esri/widgets/Zoom", "esri/widgets/NavigationToggle", "esri/widgets/Compass", "esri/widgets/DirectLineMeasurement3D",
					"esri/widgets/AreaMeasurement3D", "esri/Camera"
				],
				function(Map, MapView, SceneView, BaseTileLayer, TileInfo, WebTileLayer, LabelSymbol3D, Color, DirectLineMeasurement3DViewModel, AreaMeasurement3DViewModel,
					esriConfig, Basemap, esriRequest, BasemapGallery, Expand, ScaleBar, TileLayer, MapImageLayer, FeatureLayer, LayerList, urlUtils,
					QueryTask, Query, Graphic, GraphicsLayer, Point, TextSymbol, ElevationLayer, LabelClass,
					WebMap, Draw, Polygon, Polyline, geometryEngine, Legend, PictureMarkerSymbol, Font, IdentifyTask, IdentifyParameters, arrayUtils,
					Zoom, NavigationToggle, Compass, DirectLineMeasurement3D,
					AreaMeasurement3D, Camera) {
					var rings = [
						[
							[119.1, 50.0],
							[119.1, 51.0],
							[121.0, 51.0],
							[121.0, 50.0],
							[119.1, 50.0] // same as first vertex
						]
					];
					var eErGuNaPolygon = new Polygon({
						hasZ: false,
						hasM: false,
						rings: rings,
						spatialReference: {
							wkid: 4326
						}
					});
					var tdtImagerLayer = BaseTileLayer.createSubclass({
						properties: {
							urlTemplate: null
						},
						getTileUrl: function(level, row, col) {
							var url = "http://t" + col % 8 + ".tianditu.com/DataServer?T=img_w&x=" + col + "&y=" + row + "&l=" + level + "&tk=d382db32edadb2d02f137a669e8d1308";
							return url;
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
									responseType: "image"
								})
								.then(function(response) {
									var image = response.data;
									var width = this.tileInfo.size[0];
									var height = this.tileInfo.size[0];
									var canvas = document.createElement("canvas");
									var context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;
									context.drawImage(image, 0, 0, width, height);
									return canvas;
								}.bind(this));
						}
					});
					var tdtbizoZLayer = BaseTileLayer.createSubclass({
						properties: {
							urlTemplate: null
						},
						getTileUrl: function(level, row, col) {
							var url = "http://t" + col % 8 + ".tianditu.com/DataServer?T=cva_w&x=" + col + "&y=" + row + "&l=" + level + "&tk=d382db32edadb2d02f137a669e8d1308";
							return url;
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
									responseType: "image"
								})
								.then(function(response) {
									var image = response.data;
									var width = this.tileInfo.size[0];
									var height = this.tileInfo.size[0];
									var canvas = document.createElement("canvas");
									var context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;
									context.drawImage(image, 0, 0, width, height);
									return canvas;
								}.bind(this));
						}
					});
					var tdtVectLayer = BaseTileLayer.createSubclass({
						properties: {
							urlTemplate: null
						},
						getTileUrl: function(level, row, col) {
							var url = "http://t" + col % 8 + ".tianditu.com/DataServer?T=vec_w&x=" + col + "&y=" + row + "&l=" + level + "&tk=d382db32edadb2d02f137a669e8d1308";
							return url;
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
									responseType: "image"
								})
								.then(function(response) {
									var image = response.data;
									var width = this.tileInfo.size[0];
									var height = this.tileInfo.size[0];
									var canvas = document.createElement("canvas");
									var context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;
									context.drawImage(image, 0, 0, width, height);
									return canvas;
								}.bind(this));
						}
					});
					var TintLayer = WebTileLayer.createSubclass({
						properties: {
							urlTemplate: null,
							tint: {
								value: null,
								type: Color
							}
						},
						getTileUrl: function(level, row, col) {
							return this.urlTemplate.replace("{z}", level).replace("{x}", col).replace("{y}", row);
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
								responseType: "image",
								allowImageDataAccess: true
							}).then(function(response) {
								var image = response.data;
								var width = this.tileInfo.size[0];
								var height = this.tileInfo.size[0];
								var canvas = document.createElement("canvas");
								var context = canvas.getContext("2d");
								canvas.width = width;
								canvas.height = height;
								context.drawImage(image, 0, 0, width, height);
								return canvas;
							}.bind(this));
						}
					});
					esriConfig.request.corsEnabledServers.push("t0.tianditu.cn", "t1.tianditu.cn", "t2.tianditu.cn", "t3.tianditu.cn", "t4.tianditu.cn", "t5.tianditu.cn", "t6.tianditu.cn", "t7.tianditu.cn");
					//天地图
					var ggVectorLayer = new tdtVectLayer();
					//底图标注  
					var ggLabelLayer = new tdtbizoZLayer();
					//天地图
					var ggSatelliteLayer = new tdtImagerLayer();
					var imageBasemap2 = new Basemap({
						baseLayers: [ggSatelliteLayer, ggLabelLayer],
						title: "卫星影像",
						id: "imageBasemap",
						thumbnailUrl: "img/satellite.png"
					});
					var vectorBasemap2 = new Basemap({
						baseLayers: [ggVectorLayer, ggLabelLayer],
						title: "行政区划",
						id: "vectorBasemap",
						thumbnailUrl: "img/streets.png"
					});

					map = new Map({
						basemap: imageBasemap2,
						ground: "world-elevation" // show elevation
					});

					// 初始地图视角
					var cam = new Camera({
						position: { // observation point
							x: 111.32800,
							y: 38.01493,
							z: 3000 // altitude in meters
						},
						tilt: 70 // perspective in degrees
					});
					view = new SceneView({
						container: "viewDiv",
						camera: cam,
						map: map,
					});

					// 底图切换
					var basemapGallery = new BasemapGallery({
						view: view,
						container: document.createElement("div"),
						source: [vectorBasemap2, imageBasemap2]
					});

					var bgExpand = new Expand({
						view: view,
						content: basemapGallery.container,
						expandIconClass: "esri-icon-basemap"
					});

					view.ui.remove("attribution");

					// 显示鼠标经纬度
					document.getElementById("PositionInfo").style.display = "inline";
					view.ui.add(bgExpand, "top-right");
					view.on("pointer-move", pointerMoveEventHandler);

					function pointerMoveEventHandler(event) {

						view.when(function(response) {
							var point = view.toMap({
								x: event.x,
								y: event.y
							});
							if(point == null) {
								return;
							}
							var lonlat = mercator2lonlat(point);
							var longitude = lonlat.x;
							var latitude = lonlat.y;
							var longtD = parseInt(longitude);
							var latD = parseInt(latitude);
							var longtM = parseInt((longitude - longtD) * 60);
							var latM = parseInt((latitude - latD) * 60);
							var longtS = (((longitude - longtD) * 60 - longtM) * 60).toFixed(2);
							var latS = (((latitude - latD) * 60 - latM) * 60).toFixed(2);
							var jingDu = longtD + '°' + longtM + '′' + longtS + '″';
							var weiDu = latD + '°' + latM + '′' + latS + '″';
							// console.log(jingDu+"------------"+weiDu);
							document.getElementById("pointlongt").innerHTML = jingDu;
							document.getElementById("pointlat").innerHTML = weiDu;

						});
					}
					// 初始地图
					document.getElementById("topbar_intit_map").style.display = "inline";
					view.ui.add("topbar_intit_map", "top-left");
					document
						.getElementById("intit_map")
						.addEventListener("click", function() {
							view.goTo(cam);
						});

					// 长度,面积量算
					var activeWidget = null;
					// add the toolbar for the measurement widgets
					document.getElementById("topbar_measure_line").style.display = "inline";
					view.ui.add("topbar_measure_line", "top-left");

					document.getElementById("topbar_measure_area").style.display = "inline";
					view.ui.add("topbar_measure_area", "top-left");
					document
						.getElementById("distanceButton")
						.addEventListener("click", function() {
							setActiveWidget(null);
							if(!this.classList.contains("active")) {
								setActiveWidget("distance");
							} else {
								setActiveButton(null);
							}
						});
					document
						.getElementById("areaButton")
						.addEventListener("click", function() {
							setActiveWidget(null);
							if(!this.classList.contains("active")) {
								setActiveWidget("area");
							} else {
								setActiveButton(null);
							}
						});

					function setActiveWidget(type) {
						switch(type) {
							case "distance":
								activeWidget = new DirectLineMeasurement3D({
									view: view
								});

								// skip the initial 'new measurement' button
								activeWidget.viewModel.newMeasurement();

								view.ui.add(activeWidget, "top-right");
								setActiveButton(document.getElementById("distanceButton"));
								break;
							case "area":
								activeWidget = new AreaMeasurement3D({
									view: view
								});

								// skip the initial 'new measurement' button
								activeWidget.viewModel.newMeasurement();

								view.ui.add(activeWidget, "top-right");
								setActiveButton(document.getElementById("areaButton"));
								break;
							case null:
								if(activeWidget) {
									view.ui.remove(activeWidget);
									activeWidget.destroy();
									activeWidget = null;
								}
								break;
						}
					}

					function setActiveButton(selectedButton) {
						// focus the view to activate keyboard shortcuts for sketching
						view.focus();
						var elements = document.getElementsByClassName("active");
						for(var i = 0; i < elements.length; i++) {
							elements[i].classList.remove("active");
						}
						if(selectedButton) {
							selectedButton.classList.add("active");
						}
					}

					// 刷新
					document.getElementById("topbar_refresh").style.display = "inline";
					view.ui.add("topbar_refresh", "top-left");
					document
						.getElementById("refresh")
						.addEventListener("click", function() {
							location.reload();
						});
				});
		</script>
	</head>

	<body>
		<div id="viewDiv"></div>
		<!--鼠标经纬度-->
		<div id="PositionInfo" style="display: none;z-index: 10">
			<span>经度:</span><span id="pointlongt" style="display:inline-block;width:120px;">----------</span>
			<span style="padding-left:10px;display:inline-block;">纬度:</span><span id="pointlat" style="display:inline-block;width:120px;">----------</span>
		</div>
		<!--自定义工具栏-->
		<!--初始地图-->
		<div style="display: none;background-color: #FFFFFF;" id="topbar_intit_map">
			<button class="nomal-button esri-icon-globe" id="intit_map" type="button" title="初始地图"></button>
		</div>
		<div style="display: none;background-color: #FFFFFF;" id="topbar_refresh">
			<button class="nomal-button esri-icon-refresh" id="refresh" type="button" title="刷新"></button>
		</div>
		<!--长度量算-->
		<div style="display: none;background-color: #FFFFFF;" id="topbar_measure_line">
			<button class="action-button esri-icon-measure-line" id="distanceButton" type="button" title="长度量算"></button>
		</div>
		<!--面积量算-->
		<div style="display: none;background-color: #FFFFFF;" id="topbar_measure_area">
			<button class="action-button esri-icon-measure-area" id="areaButton" type="button" title="面积量算"></button>
		</div>

	</body>

</html>