<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>ArcGIS API for JavaScript Hello World App</title>
		<style>
			html,
			body,
			#viewDiv {
				padding: 0;
				margin: 0;
				height: 100%;
				width: 100%;
			}
		</style>

		<link rel="stylesheet" href="https://js.arcgis.com/4.13/esri/css/main.css">
		<script src="https://js.arcgis.com/4.13/"></script>

		<script>
			require(["esri/Map", "esri/views/MapView", "esri/views/SceneView", "esri/layers/BaseTileLayer", "esri/layers/support/TileInfo", "esri/layers/WebTileLayer", "esri/symbols/LabelSymbol3D", "esri/Color", "esri/widgets/DirectLineMeasurement3D/DirectLineMeasurement3DViewModel", "esri/widgets/AreaMeasurement3D/AreaMeasurement3DViewModel",
					"esri/config", "esri/Basemap", "esri/request", "esri/widgets/BasemapGallery", "esri/widgets/Expand", "esri/widgets/ScaleBar",
					"esri/layers/TileLayer", "esri/layers/MapImageLayer", "esri/layers/FeatureLayer", "esri/widgets/LayerList", "esri/core/urlUtils",
					"esri/tasks/QueryTask", "esri/tasks/support/Query", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/geometry/Point", "esri/symbols/TextSymbol", "esri/layers/ElevationLayer",
					"esri/layers/support/LabelClass", "esri/WebMap", "esri/views/2d/draw/Draw", "esri/geometry/Polygon", "esri/geometry/Polyline",
					"esri/geometry/geometryEngine", "esri/widgets/Legend", "esri/symbols/PictureMarkerSymbol", "esri/symbols/Font", "esri/tasks/IdentifyTask", "esri/tasks/support/IdentifyParameters", "dojo/_base/array",
					"esri/widgets/Zoom", "esri/widgets/NavigationToggle", "esri/widgets/Compass"
				],
				function(Map, MapView, SceneView, BaseTileLayer, TileInfo, WebTileLayer, LabelSymbol3D, Color, DirectLineMeasurement3DViewModel, AreaMeasurement3DViewModel,
					esriConfig, Basemap, esriRequest, BasemapGallery, Expand, ScaleBar, TileLayer, MapImageLayer, FeatureLayer, LayerList, urlUtils,
					QueryTask, Query, Graphic, GraphicsLayer, Point, TextSymbol, ElevationLayer, LabelClass,
					WebMap, Draw, Polygon, Polyline, geometryEngine, Legend, PictureMarkerSymbol, Font, IdentifyTask, IdentifyParameters, arrayUtils,
					Zoom, NavigationToggle, Compass) {
					var rings = [
						[
							[119.1, 50.0],
							[119.1, 51.0],
							[121.0, 51.0],
							[121.0, 50.0],
							[119.1, 50.0] // same as first vertex
						]
					];

					var eErGuNaPolygon = new Polygon({
						hasZ: false,
						hasM: false,
						rings: rings,
						spatialReference: {
							wkid: 4326
						}
					});

					var tdtImagerLayer = BaseTileLayer.createSubclass({
						properties: {
							urlTemplate: null
						},
						getTileUrl: function(level, row, col) {
							var url = "http://t" + col % 8 + ".tianditu.com/DataServer?T=img_w&x=" + col + "&y=" + row + "&l=" + level + "&tk=d382db32edadb2d02f137a669e8d1308";
							return url;
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
									responseType: "image"
								})
								.then(function(response) {

									var image = response.data;
									var width = this.tileInfo.size[0];
									var height = this.tileInfo.size[0];

									var canvas = document.createElement("canvas");
									var context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;

									context.drawImage(image, 0, 0, width, height);

									return canvas;
								}.bind(this));
						}
					});

					var tdtbizoZLayer = BaseTileLayer.createSubclass({
						properties: {
							urlTemplate: null
						},
						getTileUrl: function(level, row, col) {
							var url = "http://t" + col % 8 + ".tianditu.com/DataServer?T=cva_w&x=" + col + "&y=" + row + "&l=" + level + "&tk=d382db32edadb2d02f137a669e8d1308";
							return url;
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
									responseType: "image"
								})
								.then(function(response) {

									var image = response.data;
									var width = this.tileInfo.size[0];
									var height = this.tileInfo.size[0];

									var canvas = document.createElement("canvas");
									var context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;

									context.drawImage(image, 0, 0, width, height);

									return canvas;
								}.bind(this));
						}
					});

					var tdtVectLayer = BaseTileLayer.createSubclass({
						properties: {
							urlTemplate: null
						},
						getTileUrl: function(level, row, col) {
							var url = "http://t" + col % 8 + ".tianditu.com/DataServer?T=vec_w&x=" + col + "&y=" + row + "&l=" + level + "&tk=d382db32edadb2d02f137a669e8d1308";
							return url;
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
									responseType: "image"
								})
								.then(function(response) {

									var image = response.data;
									var width = this.tileInfo.size[0];
									var height = this.tileInfo.size[0];

									var canvas = document.createElement("canvas");
									var context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;

									context.drawImage(image, 0, 0, width, height);

									return canvas;
								}.bind(this));
						}
					});

					var TintLayer = WebTileLayer.createSubclass({
						properties: {
							urlTemplate: null,
							tint: {
								value: null,
								type: Color
							}
						},
						getTileUrl: function(level, row, col) {
							return this.urlTemplate.replace("{z}", level).replace("{x}", col).replace("{y}", row);
						},
						fetchTile: function(level, row, col) {
							var url = this.getTileUrl(level, row, col);
							return esriRequest(url, {
								responseType: "image",
								allowImageDataAccess: true
							}).then(function(response) {
								var image = response.data;
								var width = this.tileInfo.size[0];
								var height = this.tileInfo.size[0];
								var canvas = document.createElement("canvas");
								var context = canvas.getContext("2d");
								canvas.width = width;
								canvas.height = height;
								context.drawImage(image, 0, 0, width, height);
								return canvas;
							}.bind(this));
						}

					});

					esriConfig.request.corsEnabledServers.push("t0.tianditu.cn", "t1.tianditu.cn", "t2.tianditu.cn", "t3.tianditu.cn", "t4.tianditu.cn", "t5.tianditu.cn", "t6.tianditu.cn", "t7.tianditu.cn");

					//天地图
					var ggVectorLayer = new tdtVectLayer();

					//底图标注  
					var ggLabelLayer = new tdtbizoZLayer();

					//天地图
					var ggSatelliteLayer = new tdtImagerLayer();
					var imageBasemap2 = new Basemap({
						baseLayers: [ggSatelliteLayer, ggLabelLayer],
						title: "卫星影像",
						id: "imageBasemap",
						thumbnailUrl: "img/satellite.png"
					});
					var vectorBasemap2 = new Basemap({
						baseLayers: [ggVectorLayer, ggLabelLayer],
						title: "行政区划",
						id: "vectorBasemap",
						thumbnailUrl: "img/streets.png"
					});
					
					var map = new Map({
						basemap: imageBasemap2,
						ground: "world-elevation" // show elevation
					});
					
					var view = new SceneView({
						container: "viewDiv",
						map: map,
						camera: {
							position: { // observation point
								x: 111.32800,
								y: 38.01493,
								z: 25000 // altitude in meters
							},
							tilt: 65 // perspective in degrees
						}
					});
					
					// 底图切换
					var basemapGallery = new BasemapGallery({
						view: view,
						container: document.createElement("div"),
						source: [vectorBasemap2, imageBasemap2]
					});

					
					var bgExpand = new Expand({
						view: view,
						content: basemapGallery.container,
						expandIconClass: "esri-icon-basemap"
					});
					
					view.ui.add(bgExpand, "top-right");
				});
		</script>
	</head>

	<body>
		<div id="viewDiv"></div>
	</body>

</html>